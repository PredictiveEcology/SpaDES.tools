<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Simulate a contagious spread process on a landscape, with data.table internals — spread2 • SpaDES.tools</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Simulate a contagious spread process on a landscape, with data.table internals — spread2"><meta property="og:description" content='This can be used to simulate fires, seed dispersal, calculation of iterative,
concentric, symmetric (currently) landscape values and many other things.
Essentially, it starts from a collection of cells (start, called "events")
and spreads to neighbours, according to the directions
and spreadProb with modifications due to other arguments. NOTE:
the spread function is similar, but sometimes slightly faster, but less
robust, and more difficult to use iteratively.'><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaDES.tools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/PredictiveEcology/SpaDES.tools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Simulate a contagious spread process on a landscape, with <code>data.table</code> internals</h1>
    <small class="dont-index">Source: <a href="https://github.com/PredictiveEcology/SpaDES.tools/blob/HEAD/R/spread2.R" class="external-link"><code>R/spread2.R</code></a></small>
    <div class="hidden name"><code>spread2.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This can be used to simulate fires, seed dispersal, calculation of iterative,
concentric, symmetric (currently) landscape values and many other things.
Essentially, it starts from a collection of cells (<code>start</code>, called "events")
and spreads to neighbours, according to the <code>directions</code>
and <code>spreadProb</code> with modifications due to other arguments. <strong>NOTE:</strong>
the <code>spread</code> function is similar, but sometimes slightly faster, but less
robust, and more difficult to use iteratively.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">spread2</span><span class="op">(</span></span>
<span>  <span class="va">landscape</span>,</span>
<span>  start <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">landscape</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="op">-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">landscape</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>,</span>
<span>  spreadProb <span class="op">=</span> <span class="fl">0.23</span>,</span>
<span>  persistProb <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  asRaster <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">maxSize</span>,</span>
<span>  <span class="va">exactSize</span>,</span>
<span>  directions <span class="op">=</span> <span class="fl">8L</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">1000000L</span>,</span>
<span>  returnDistances <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  returnDirections <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  returnFrom <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  maxRetriesPerID <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  spreadProbRel <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  plot.it <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  circle <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  asymmetry <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  asymmetryAngle <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  allowOverlap <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  neighProbs <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  oneNeighbourOnly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  skipChecks <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>landscape</dt>
<dd><p>Required. A <code>RasterLayer</code> object. This defines the possible
locations for spreading events to start and <code>spread2</code> into. Required.</p></dd>


<dt>start</dt>
<dd><p>Required. Either a vector of pixel numbers to initiate spreading, or a
<code>data.table</code> that is the output of a previous <code>spread2</code>.
If a vector, they should be cell indices (pixels) on the <code>landscape</code>.
If user has x and y coordinates, these can be converted with
<code><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY()</a></code>.</p></dd>


<dt>spreadProb</dt>
<dd><p>Numeric of length 1 or length <code>ncell(landscape)</code> or
a <code>RasterLayer</code> that is the identical dimensions as
<code>landscape</code>.
If numeric of length 1, then this is the global (absolute)
probability of spreading into each cell from a neighbour.
If a numeric of length <code>ncell(landscape)</code> or a raster,
then this must be the cell-specific (absolute)
probability of a "receiving" potential cell. Default is <code>0.23</code>.
If relative probabilities are required, use <code>spreadProbRel</code>.
If used together, then the relative probabilities will be
re-scaled so that the mean relative probability of potential
neighbours is equal to the mean of <code>spreadProb</code> of
the potential neighbours.</p></dd>


<dt>persistProb</dt>
<dd><p>Numeric of length 1 or <code>RasterLayer</code>.
If numeric of length 1, then this is the global (absolute)
probability of cell continuing to burn per time step.
If a raster, then this must be the cell-specific (absolute)
probability of a fire persisting.
Default is <code>NA</code>, which is the same as 0, i.e. a cell only burns
for one time step.</p></dd>


<dt>asRaster</dt>
<dd><p>Logical, length 1. If <code>TRUE</code>, the function will return a <code>Raster</code>
where raster non NA values indicate the cells that were "active", and the
value is the initial starting pixel.</p></dd>


<dt>maxSize</dt>
<dd><p>Numeric. Maximum number of cells for a single or all events to be <code>spread2</code>.
Recycled to match <code>start</code> length, if it is not as long as <code>start</code>.
This will be overridden if <code>exactSize</code> also provided.
See section on 'Breaking out of <code>spread2</code> events'.</p></dd>


<dt>exactSize</dt>
<dd><p>Numeric vector, length 1 or <code>length(start)</code>.
Similar to <code>maxSize</code>, but these will be the exact
final sizes of the events.  i.e., the <code>spread2</code> events
will continue until they are <code>floor(exactSize)</code>.
This will override <code>maxSize</code> if both provided.
See Details.</p></dd>


<dt>directions</dt>
<dd><p>The number adjacent cells in which to look;
default is 8 (Queen case). Can only be 4 or 8.</p></dd>


<dt>iterations</dt>
<dd><p>Number of iterations to <code>spread2</code>.
Leaving this <code>NULL</code> allows the <code>spread2</code> to continue
until stops spreading itself (i.e., exhausts itself).</p></dd>


<dt>returnDistances</dt>
<dd><p>Logical. Should the function include a column with the
individual cell distances from the locus where that event
started. Default is FALSE. See Details.</p></dd>


<dt>returnDirections</dt>
<dd><p>Logical. Should the function include a column with the
individual directions (in radians) from the locus where
that event started. Default is FALSE.</p></dd>


<dt>returnFrom</dt>
<dd><p>Logical. Should the function return a column with the
source, i.e, the lag 1 "from" pixel, for each iteration.</p></dd>


<dt>maxRetriesPerID</dt>
<dd><p>Only active if <code>exactSize</code> is used. This is the number of attempts
that will be made per event ID, before abandoning, therefore completing
the <code>spread2</code> for that event with a size that is smaller than
<code>exactSize</code>. Default 10 times.</p></dd>


<dt>spreadProbRel</dt>
<dd><p>Optional <code>RasterLayer</code> indicating a surface of relative
probabilities useful when using <code>neighProbs</code> (which
provides a mechanism for selecting a specific number of
cells at each iteration).
This indicates the relative probabilities for the selection
of successful neighbours.
<code>spreadProb</code> will still be evaluated <em>after</em>
the relative probabilities and <code>neighProbs</code> has been
evaluated, i.e., potential cells will be identified, then
some could be rejected via <code>spreadProb</code>.
If absolute <code>spreadProb</code> is not desired,
<em>be sure to set</em> <code>spreadProb = 1</code>.
Ignored if <code>neighProbs</code> is not provided.</p></dd>


<dt>plot.it</dt>
<dd><p>If <code>TRUE</code>, then plot the raster at every iteration,
so one can watch the <code>spread2</code> event grow.</p></dd>


<dt>circle</dt>
<dd><p>Logical. If TRUE, then outward <code>spread2</code> will be by equidistant rings,
rather than solely by adjacent cells (via <code>directions</code> arg.).
Default is <code>FALSE</code>.
Using <code>circle = TRUE</code> can be dramatically slower for large problems.
Note, this will likely create unexpected results if <code>spreadProb &lt; 1</code>.</p></dd>


<dt>asymmetry</dt>
<dd><p>A numeric or <code>RasterLayer</code> indicating the ratio of the
asymmetry to be used. i.e., 1 is no asymmetry; 2 means that the
angles in the direction of the <code>asymmetryAngle</code> are 2x the
<code>spreadProb</code>
of the angles opposite tot he <code>asymmetryAngle</code>  Default is
NA, indicating no asymmetry. See details. This is still experimental.
Use with caution.</p></dd>


<dt>asymmetryAngle</dt>
<dd><p>A numeric or <code>RasterLayer</code> indicating the angle in degrees
(0 is "up", as in North on a map),
that describes which way the <code>asymmetry</code> is.</p></dd>


<dt>allowOverlap</dt>
<dd><p><code>numeric</code> (<code>logical</code> will work for backwards compatibility).
See details.  Default is 0, i.e., no overlapping.</p></dd>


<dt>neighProbs</dt>
<dd><p>An optional numeric vector, whose sum is 1.
It indicates the probabilities that an individual spread iteration
will spread to <code>1, 2, ..., length(neighProbs)</code> neighbours, respectively.
If this is used (i.e., something other than <code>NA</code>), <code>circle</code> and
<code>returnDistances</code> will not work currently.</p></dd>


<dt>oneNeighbourOnly</dt>
<dd><p>Logical. Default is <code>FALSE</code>. If <code>TRUE</code>, then this
spread algorithm will allow exactly one neighbour to be
spread to (not fewer or more). This could be used, e.g.,
for an animal moving. If this is <code>TRUE</code>, then <code>allowOverlap</code>
will be set to <code>2</code> if it is <code>0</code> or <code>1</code>.</p></dd>


<dt>skipChecks</dt>
<dd><p>Logical. If TRUE, the argument checking (i.e., assertions) will be
skipped. This should likely only be used once it is clear that the function
arguments are well understood and function speed is of the primary importance.
This is likely most useful in repeated iteration cases i.e., if this call
is using the previous output from this same function.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>Either a <code>data.table</code> (<code>asRaster=FALSE</code>) or a <code>RasterLayer</code></p>


<p>(<code>asRaster=TRUE</code>, the default).
The <code>data.table</code> will have one attribute named <code>spreadState</code>, which
is a list containing a <code>data.table</code> of current cluster-level information
about the spread events.
If <code>asRaster=TRUE</code>, then the <code>data.table</code> (with its <code>spreadState</code></p>


<p>attribute) will be attached to the <code>Raster</code> as an attribute named <code>pixel</code> as it
provides pixel-level information about the spread events.</p>


<p>The <code>RasterLayer</code> represents every cell in which a successful <code>spread2</code> event occurred.
For the case of, say, a fire this would represent every cell that burned.
If <code>allowOverlap</code> is <code>TRUE</code>, the return will always be a <code>data.table</code>.</p>


<p>If <code>asRaster</code> is <code>FALSE</code>, then this function returns a
<code>data.table</code> with 3 (or 4 if <code>returnFrom</code> is <code>TRUE</code>) columns:</p>


<table class="table table"><tr><td><code>initialPixels</code></td><td>the initial cell number of that particular
<code>spread2</code> event.</td></tr><tr><td><code>pixels</code></td><td>The cell indices of cells that have
been touched by the <code>spread2</code> algorithm.</td></tr><tr><td><code>state</code></td><td>a logical indicating whether the cell is active (i.e.,
could still be a source for spreading) or not (no
spreading will occur from these cells).</td></tr><tr><td><code>from</code></td><td>The pixel indices that were the immediately preceding
"source" for each <code>pixels</code>, i.e., the lag 1 pixels.
Only returned if <code>returnFrom</code> is <code>TRUE</code></td></tr></table><p>The attribute saved with the name <code>"spreadState"</code> (e.g., <code>attr(output, "spreadState")</code>)
includes a <code>data.table</code> with columns:</p><table class="table table"><tr><td><code>id</code></td><td>An arbitrary code, from 1 to <code>length(start)</code> for each "event".</td></tr><tr><td><code>initialPixels</code></td><td>the initial cell number of that particular
<code>spread2</code> event.</td></tr><tr><td><code>numRetries</code></td><td>The number of re-starts the event did because it got
stuck (normally only because <code>exactSize</code> was used
and was not achieved.</td></tr><tr><td><code>maxSize</code></td><td>The number of pixels that were provided as inputs via
<code>maxSize</code> or <code>exactSize</code>.</td></tr><tr><td><code>size</code></td><td>The current size, in pixels, of each event.</td></tr></table><p>and several other objects that provide significant speed ups in iterative calls to
<code>spread2</code>. If the user runs <code>spread2</code> iteratively, there will likely be significant
speed gains if the <code>data.table</code> passed in to <code>start</code> should have the attribute
attached, or re-attached if it was lost, e.g., via
<code>setattr(outInput, "spreadState", attr(out, "spreadState"))</code>, where <code>out</code> is the
returned <code>data.table</code> from the previous call to <code>spread2</code>, and <code>outInput</code> is
the modified <code>data.table</code>. Currently, the modified <code>data.table</code></p>
<p></p>
<p><strong>must</strong> have the
same order as <code>out</code>.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>There are 2 main underlying algorithms for active cells to "spread" to
nearby cells (adjacent cells): <code>spreadProb</code> and <code>neighProb</code>.
Using <code>spreadProb</code>, every "active" pixel will assess all
neighbours (either 4 or 8, depending on  <code>directions</code>), and will "activate"
whichever neighbours successfully pass independent calls to
<code>runif(1,0,1) &lt; spreadProb</code>.
The algorithm will iterate again and again, each time starting from the newly
"activated" cells. Several built-in decisions are as follows.</p><ol><li><p>no active cell can activate a cell that was already activated by
the same event (i.e., "it won't go backwards"). 2. If <code>allowOverlap</code> is
<code>FALSE</code>, then the previous rule will also apply, regardless of which
"event" caused the pixels to be previously active.</p></li>
</ol><p>This function can be interrupted before all active cells are exhausted if
the <code>iterations</code> value is reached before there are no more active
cells to <code>spread2</code> into. The interrupted output (a <code>data.table</code>) can be passed
subsequently as an input to this same function (as <code>start</code>).
This is intended to be used for situations where external events happen during
a <code>spread2</code> event, or where one or more arguments to the <code>spread2</code> function
change before a <code>spread2</code> event is completed.
For example, if it is desired that the <code>spreadProb</code> change before a
<code>spread2</code> event is completed because, for example, a fire is spreading, and a
new set of conditions arise due to a change in weather.</p>
<p><code>asymmetry</code> here is slightly different than in the <code>spread</code> function,
so that it can deal with a <code>RasterLayer</code> of <code>asymmetryAngle</code>.
Here, the <code>spreadProb</code> values of a given set of neighbours around each active pixel
are adjusted to create <code>adjustedSpreadProb</code> which is calculated maintain the
following two qualities: $$mean(spreadProb) = mean(ajustedSpreadProb)$$ and
$$max(spreadProb)/min(spreadProb) = asymmetry$$ along the axis of
<code>asymmetryAngle</code>. NOTE: this means that the 8 neighbours around an active
cell may not fulfill the preceeding equality if <code>asymmetryAngle</code> is not
exactly one of the 8 angles of the 8 neighbours. This means that
$$max(spreadProb)/min(spreadProb)$$ will generally be less than
<code>asymmetry</code>, for the 8 neighbours. The exact adjustment to the spreadProb
is calculated with:
$$angleQuality &lt;- (cos(angles - rad2(asymmetryAngle))+1)/2$$
which is multiplied to get an angle-adjusted spreadProb:
$$spreadProbAdj &lt;- actualSpreadProb * angleQuality$$
which is then rescaled:
$$adjustedSpreadProb = (spreadProbAdj - min(spreadProbAdj)) * par2 + par1$$,
where <code>par1</code> and <code>par2</code> are parameters calculated internally to make the 2 conditions above true.</p>
<p>If <code>maxSize</code> or <code>exactSize</code> are used, then spreading will continue and stop
before or at <code>maxSize</code> or at <code>exactSize</code>, respectively.
If <code>iterations</code> is specified, then the function will end, and the returned <code>data.table</code>
may (if <code>maxSize</code>) or will (if <code>exactSize</code>) have at least one active
cell per event that did not already achieve <code>maxSize</code> or <code>exactSize</code>.
This will be very useful to build new, customized higher-level wrapper functions that
iteratively call <code>spread2</code>.</p>
    </div>
    <div id="note">
    <h2>Note</h2>
    <p><code>exactSize</code> may not be achieved if there aren't enough cells in the map.
Also, <code>exactSize</code> may not be achieved because the active cells are "stuck",
i.e., they have no inactivated cells to move to; or the <code>spreadProb</code> is low.
In the latter two cases, the algorithm will retry again, but it will only
retry from the last iteration's active cells.
The algorithm will only retry 10 times before quitting.
Currently, there will also be an attempt to "jump" up to four cells away from
the active cells to try to continue spreading.</p>
<p>A common way to use this function is to build wrappers around this, followed
by iterative calls in a <code>while</code> loop. See example.</p>
    </div>
    <div id="breaking-out-of-spread-events">
    <h2>Breaking out of <code>spread2</code> events</h2>
    


<p>There are 3 ways for the <code>spread2</code> to "stop" spreading.
Here, each "event" is defined as all cells that are spawned from each unique
<code>start</code> location.
The ways outlined below are all acting at all times, i.e., they are not
mutually exclusive.
Therefore, it is the user's responsibility to make sure the different rules
are interacting with each other correctly.</p>
<table class="table table"><tr><td><code>spreadProb</code></td><td>Probabilistically, if <code>spreadProb</code> is low enough,
active spreading events will stop.
In practice, this number generally should be below 0.3
to actually see an event stop.</td></tr><tr><td><code>maxSize</code></td><td>This is the number of cells that are "successfully" turned
on during a spreading event. <code>spreadProb</code> will still
be active, so, it is possible that the end size of each event
is smaller than <code>maxSize</code>, but they will not be greater
than <code>maxSize</code></td></tr><tr><td><code>exactSize</code></td><td>This is the number of cells that are "successfully" turned
on during a spreading event. This will override an event that
stops probabilistically via <code>spreadProb</code>, but forcing
its last set of active cells to try again to find neighbours.
It will try <code>maxRetriesPerID</code> times per event, before giving up.
During those <code>maxRetriesPerID</code> times, it will try to "jump" up to
4 cells outwards from each of the active cells, every 5 retries.</td></tr><tr><td><code>iterations</code></td><td>This is a hard cap on the number of internal iterations to
complete before returning the current state of the system
as a <code>data.table</code>.</td></tr></table></div>
    <div id="building-custom-spreading-events">
    <h2>Building custom spreading events</h2>
    


<p>This function can be used iteratively, with relatively little overhead compared to using
it non-iteratively. In general, this function can be called with arguments set as user
needs, and with specifying e.g., <code>iterations = 1</code>. This means that the function will spread
outwards 1 iteration, then stop. The returned object will be a <code>data.table</code> or
<code>RasterLayer</code> that can be passed immediately back as the start argument into a subsequent
call to <code>spread2</code>. This means that every argument can be updated at each iteration.</p>
<p>When using this function iteratively, there are several things to keep in mind.
The output will likely be sorted differently than the input (i.e., the
order of start, if a vector, may not be the same order as that returned).
This means that when passing the same object back into the next iteration of the
function call, <code>maxSize</code> or <code>exactSize</code> may not be in the same order.
To get the same order, the easiest thing to do is sort the initial <code>start</code>
objects by their pixel location, increasing.
Then, of course, sorting any vectorized arguments (e.g., <code>maxSize</code>) accordingly.</p>
<p><strong>NOTE</strong>: the <code>data.table</code> or <code>RasterLayer</code> should not be altered
when passed back into <code>spread2</code>.</p>
    </div>
    <div id="allowoverlap">
    <h2><code>allowOverlap</code></h2>
    

<p>If <code>1</code> (or <code>TRUE</code>),
then individual events can overlap with one another, i.e., allow
overlap between events. If <code>2</code> (or <code>NA</code>), then each pixel
is essentially independent, allowing overlap between and within
events. This likely requires a user to intervene as it is possible
to spread back onto itself. If <code>3</code> (did not exist previously),
individual events can overlap, and there can be overlap within an
event, but only within an iteration, i.e., once an iteration is
finished, and a pixel was activated, then the spreading will not
return onto these pixels. If <code>0</code> (or <code>FALSE</code>), then once a
pixel is activated, it cannot be re-activated, within or between event.
This allows events to not interfere with one another i.e.,
they do not interact (this is slower than if
<code>allowOverlap = FALSE</code>). Default is 0. In the case of 2 or 3,
this would be, perhaps, useful for dispersal of,
say, insect swarms.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="spread.html">spread()</a></code> for a different implementation of the same algorithm.
<code>spread</code> is less robust but it is often slightly faster.</p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Eliot McIntire and Steve Cumming</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">origDTThreads</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/openmp-utils.html" class="external-link">setDTthreads</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">origNcpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>Ncpus <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, res <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simple use -- similar to spread(...)</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, start <span class="op">=</span> <span class="va">sams</span>, <span class="fl">0.225</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use maxSize -- this gives an upper limit</span></span></span>
<span class="r-in"><span><span class="va">maxSizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sams</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, start <span class="op">=</span> <span class="va">sams</span>, <span class="fl">0.225</span>, maxSize <span class="op">=</span> <span class="va">maxSizes</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># check TRUE using data.table .N</span></span></span>
<span class="r-in"><span><span class="va">out</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="st">"initialPixels"</span><span class="op">]</span><span class="op">$</span><span class="va">N</span> <span class="op">&lt;=</span> <span class="va">maxSizes</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE TRUE TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use exactSize -- gives an exact size, if there is enough space on the Raster</span></span></span>
<span class="r-in"><span><span class="va">exactSizes</span> <span class="op">&lt;-</span> <span class="va">maxSizes</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, start <span class="op">=</span> <span class="va">sams</span>, spreadProb <span class="op">=</span> <span class="fl">0.225</span>,</span></span>
<span class="r-in"><span>               exactSize <span class="op">=</span> <span class="va">exactSizes</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="st">"initialPixels"</span><span class="op">]</span><span class="op">$</span><span class="va">N</span> <span class="op">==</span> <span class="va">maxSizes</span> <span class="co"># should be TRUE TRUE TRUE</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE TRUE TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use exactSize -- but where it can't be achieved</span></span></span>
<span class="r-in"><span><span class="va">exactSizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">110</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sams</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, start <span class="op">=</span> <span class="va">sams</span>, <span class="fl">1</span>, exactSize <span class="op">=</span> <span class="va">exactSizes</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Iterative calling -- create a function with a high escape probability</span></span></span>
<span class="r-in"><span><span class="va">spreadWithEscape</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ras</span>, <span class="va">start</span>, <span class="va">escapeProb</span>, <span class="va">spreadProb</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">ras</span>, start <span class="op">=</span> <span class="va">sams</span>, spreadProb <span class="op">=</span> <span class="va">escapeProb</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"sourceActive"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># pass in previous output as start</span></span></span>
<span class="r-in"><span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">ras</span>, start <span class="op">=</span> <span class="va">out</span>, spreadProb <span class="op">=</span> <span class="va">spreadProb</span>,</span></span>
<span class="r-in"><span>                    asRaster <span class="op">=</span> <span class="cn">FALSE</span>, skipChecks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># skipChecks for speed</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="va">out</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">421</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu">spreadWithEscape</span><span class="op">(</span><span class="va">a</span>, <span class="va">sams</span>, escapeProb <span class="op">=</span> <span class="fl">0.25</span>, spreadProb <span class="op">=</span> <span class="fl">0.225</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">421</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, <span class="va">sams</span>, <span class="fl">0.225</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># The one with high escape probability is larger (most of the time)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">out1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">out2</span><span class="op">)</span> <span class="co">## TODO: not true</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Use neighProbs, with a spreadProb that is a RasterLayer</span></span></span>
<span class="r-in"><span><span class="co"># Create a raster of different values, which will be the relative probabilities</span></span></span>
<span class="r-in"><span><span class="co">#   i.e., they are rescaled to relative probabilities within the 8 neighbour choices.</span></span></span>
<span class="r-in"><span><span class="co">#   The neighProbs below means 70% of the time, 1 neighbour will be chosen,</span></span></span>
<span class="r-in"><span><span class="co">#   30% of the time 2 neighbours.</span></span></span>
<span class="r-in"><span><span class="co">#   The cells with spreadProb of 5 are 5 times more likely than cells with 1 to be chosen,</span></span></span>
<span class="r-in"><span><span class="co">#   when they are both within the 8 neighbours</span></span></span>
<span class="r-in"><span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, res <span class="op">=</span> <span class="fl">1</span>, vals <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="co">#small raster, simple values</span></span></span>
<span class="r-in"><span><span class="co"># Check neighProbs worked</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># enough replicates to see stabilized probabilities</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">sp</span>, spreadProbRel <span class="op">=</span> <span class="va">sp</span>, spreadProb <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>                      start <span class="op">=</span> <span class="fl">5</span>, iterations <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>                      neighProbs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="va">pixels</span> <span class="op">!=</span> <span class="fl">5</span><span class="op">]</span> <span class="co"># remove starting cell</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sp</span><span class="op">[</span><span class="va">out</span><span class="op">$</span><span class="va">pixels</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lyr.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1  2  3  4  6  7  8  9 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3  4  5 10 18 11 22 27 </span>
<span class="r-in"><span><span class="co"># should be non-significant -- note no 5 because that was the starting cell</span></span></span>
<span class="r-in"><span><span class="co">#  This tests whether the null model is true ... there should be proportions</span></span></span>
<span class="r-in"><span><span class="co">#  equivalent to 1:2:3:4:6:7:8:9 ... i.e,. cell 9 should have 9x as many events</span></span></span>
<span class="r-in"><span><span class="co">#  spread to it as cell 1. This comes from sp object above which is providing</span></span></span>
<span class="r-in"><span><span class="co">#  the relative spread probabilities</span></span></span>
<span class="r-in"><span><span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/chisq.test.html" class="external-link">chisq.test</a></span><span class="op">(</span><span class="va">keep</span>, <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tabulate.html" class="external-link">tabulate</a></span><span class="op">(</span><span class="va">sp</span><span class="op">[</span><span class="va">out</span><span class="op">$</span><span class="va">pixels</span><span class="op">]</span><span class="op">$</span><span class="va">lyr.1</span>, <span class="fl">9</span><span class="op">)</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>           simulate.p.value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 	Pearson's Chi-squared test with simulated p-value (based on 2000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 	replicates)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data:  keep and unname(tabulate(sp[out$pixels]$lyr.1, 9)[keep])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> X-squared = 56, df = NA, p-value = 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Example showing asymmetry</span></span></span>
<span class="r-in"><span><span class="va">sams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span></span></span>
<span class="r-in"><span><span class="va">circs</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">a</span>, spreadProb <span class="op">=</span> <span class="fl">0.213</span>, start <span class="op">=</span> <span class="va">sams</span>,</span></span>
<span class="r-in"><span>                 asymmetry <span class="op">=</span> <span class="fl">2</span>, asymmetryAngle <span class="op">=</span> <span class="fl">135</span>,</span></span>
<span class="r-in"><span>                 asRaster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## ADVANCED: Estimate spreadProb when using asymmetry, such that the expected</span></span></span>
<span class="r-in"><span><span class="co">##   event size is the same as without using asymmetry</span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># Still using `raster` as it works more easily with parallelism due to not using pointers</span></span></span>
<span class="r-in"><span>    <span class="co">#   This will updated at a later release</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"raster"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">ras</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="va">ras</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></span>
<span class="r-in"><span>      <span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>        <span class="va">circs</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">ras</span>, spreadProb <span class="op">=</span> <span class="fl">0.225</span>,</span></span>
<span class="r-in"><span>                         start <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="va">sizes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">circs</span><span class="op">[</span>, <span class="va">.N</span><span class="op">]</span></span></span>
<span class="r-in"><span>      <span class="op">}</span></span></span>
<span class="r-in"><span>      <span class="va">goalSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"DEoptim"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>        <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ArdiaD/DEoptim" class="external-link">DEoptim</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>        <span class="co"># need 10 cores for 10 populations in DEoptim</span></span></span>
<span class="r-in"><span>        <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="op">{</span></span></span>
<span class="r-in"><span>          <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spades-tools.predictiveecology.org">SpaDES.tools</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>          <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>          <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>          <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/PredictiveEcology/fpCompare" class="external-link">fpCompare</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>        <span class="va">objFn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">20</span>, <span class="va">ras</span>, <span class="va">goalSize</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>          <span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span>          <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>            <span class="va">circs</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">ras</span>, spreadProb <span class="op">=</span> <span class="va">sp</span>, start <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>                             asymmetry <span class="op">=</span> <span class="fl">2</span>, asymmetryAngle <span class="op">=</span> <span class="fl">135</span>,</span></span>
<span class="r-in"><span>                             asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>            <span class="va">sizes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">circs</span><span class="op">[</span>, <span class="va">.N</span><span class="op">]</span></span></span>
<span class="r-in"><span>          <span class="op">}</span></span></span>
<span class="r-in"><span>          <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span> <span class="op">-</span> <span class="va">goalSize</span><span class="op">)</span></span></span>
<span class="r-in"><span>        <span class="op">}</span></span></span>
<span class="r-in"><span>        <span class="va">aa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DEoptim/man/DEoptim.html" class="external-link">DEoptim</a></span><span class="op">(</span><span class="va">objFn</span>, lower <span class="op">=</span> <span class="fl">0.2</span>, upper <span class="op">=</span> <span class="fl">0.23</span>,</span></span>
<span class="r-in"><span>                      control <span class="op">=</span></span></span>
<span class="r-in"><span>                        <span class="fu"><a href="https://rdrr.io/pkg/DEoptim/man/DEoptim.control.html" class="external-link">DEoptim.control</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>                          cluster <span class="op">=</span> <span class="va">cl</span>, NP <span class="op">=</span> <span class="fl">10</span>, VTR <span class="op">=</span> <span class="fl">0.02</span>,</span></span>
<span class="r-in"><span>                          <span class="co"># imposing itermax simply for example; should let go to completion</span></span></span>
<span class="r-in"><span>                          itermax <span class="op">=</span> <span class="fl">5</span>,</span></span>
<span class="r-in"><span>                          initialpop <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0.213</span>, <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                      ras <span class="op">=</span> <span class="va">ras</span>, goalSize <span class="op">=</span> <span class="va">goalSize</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>        <span class="co"># The value of spreadProb that will give the</span></span></span>
<span class="r-in"><span>        <span class="co">#    same expected event sizes to spreadProb = 0.225 is:</span></span></span>
<span class="r-in"><span>        <span class="va">sp</span> <span class="op">&lt;-</span> <span class="va">aa</span><span class="op">$</span><span class="va">optim</span><span class="op">$</span><span class="va">bestmem</span></span></span>
<span class="r-in"><span>        <span class="va">circs</span> <span class="op">&lt;-</span> <span class="fu">spread2</span><span class="op">(</span><span class="va">ras</span>, spreadProb <span class="op">=</span> <span class="va">sp</span>, start <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>                         asymmetry <span class="op">=</span> <span class="fl">2</span>, asymmetryAngle <span class="op">=</span> <span class="fl">135</span>, asRaster <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="op">}</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># clean up</span></span></span>
<span class="r-in"><span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/openmp-utils.html" class="external-link">setDTthreads</a></span><span class="op">(</span><span class="va">origDTThreads</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>Ncpus <span class="op">=</span> <span class="va">origNcpus</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Eliot J B McIntire, Alex M Chubaty.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer></div>

  


  

  </body></html>

